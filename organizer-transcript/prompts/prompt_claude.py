"""
Claude-optimized prompt template for earnings transcript analysis.
Updated to match Gemini output quality with full detail and all Q&A questions.
"""

def get_claude_prompt(company_name: str, ticker: str, curr: str, prev: str,
                      quarters_comparison: str, company_specific_notes: str = "") -> str:
    """Generate Claude-optimized analysis prompt."""

    return f"""## 指令开始

### A. 分析目标与背景 (Input)

1. **公司与季度：** {company_name} ({ticker}), {quarters_comparison}

2. **核心输入材料 - 当前季度 (Current Quarter - {curr}):**
   - 已上传 earnings transcript

3. **核心输入材料 - 上一季度 (Previous Quarter - {prev}):**
   - 已上传 earnings transcript

4. **分析师问答分析和季度间对比是重点**
{company_specific_notes}
---

### B. 分析输出要求 (Output Required)

**[关键指令：请不要在您的回复中重复A部分的任何内容。您的回复应直接从"1. 综合评估与投资启示"开始。]**

### C. 【必须遵守】关键输出规范 (Critical Output Rules)

**以下规则对输出质量至关重要，必须严格遵守：**

**1. 引用来源页码（最重要）：**
   - 每个关键数据点必须标注来源，格式：`({curr} transcript p.X)` 或 `({prev} transcript p.Y)`
   - Q&A分析中的每个问答必须标注页码
   - 催化剂事件也必须标注来源页码
   - 示例：`Cloud：{curr} $17.7B（+48% YoY）vs {prev} $15.2B（+34% YoY）({curr} transcript p.9；{prev} transcript p.9)`

**2. 核心结论的结构化拆解：**
   - 不要写成一个大段落
   - 必须按业务维度拆解，至少包含以下3个子主题：
     * **增长动能**：哪个业务在加速/减速？具体数字是什么？{curr} vs {prev}的变化？
     * **盈利质量**：EPS变化的真实驱动是什么？一次性项目有哪些？需要调整的口径？
     * **资本强度/现金流**：CapEx/FCF的变化？对估值的影响？
   - 每个子主题都要有具体数字和来源页码

**3. 【重要】可比性陷阱警告：**
   - 必须明确指出两季度之间的"可比性陷阱"
   - 例如：一次性项目（罚款、股权激励费用）、Other income/expense波动、会计口径变化
   - 格式："{prev}有$X的[项目]，{curr}有$Y的[项目]，导致EPS/利润率的季度对比存在扰动"
   - 告诉读者"不应机械解读为经营转弱/转强"

**4. 强调"变化"而非"状态"：**
   - 重点是{curr}相比{prev}"变了什么"，而不是{curr}"是什么"
   - 使用对比语言："+17% YoY vs {prev}的+15% YoY → 加速"
   - 明确标注：加速/减速/持平/恶化/改善

**5. 投资决策导向：**
   - "对估值/模型的影响"部分必须回答以下具体问题：
     * **收入侧**：模型该上修还是下修？概率多大？
     * **成本/资本侧**：FCF路径需要怎么改？
     * **估值框架**：乘数应该怎么变？为什么？
   - 用"你需要..."或"模型必须..."的语气，像在给分析师同事写备忘录
   - 必须有"投资启示（决策导向）"总结段落

**6. Q&A部分的深度要求【最关键】：**
   - 统计问题总数："{curr}共X个问题，{prev}共Y个问题"
   - **【强制】必须列出Q&A中的每一个问题，不能遗漏！** 如果有15个问题，就要列出15个问题；如果有20个问题，就要列出20个问题。绝对不能只列"代表性"的几个问题。
   - 每个问题必须标注来源页码，格式：`(p.15-16)`
   - 不只是列出问答，还要分析"管理层回答了什么、没回答什么"
   - 对于回避的问题，明确指出"未回答"或"回答偏向定性，缺少量化锚点"
   - 评估回答的"可建模性"——投资者能否基于回答调整财务模型？
   - 标注"二阶效应"（需要更关注的间接影响）

**7. 【Claude专用】详细且有深度：**
   - 不要追求简洁，要追求完整和深度
   - 每个观点都必须有数据支撑和页码引用
   - 如果transcript中没有明确数据，直接写"未披露"而不是推测
   - 输出风格应该更像"投行研究报告"而非"新闻摘要"
   - 分析要全面，不要省略任何重要信息

---

请根据A部分两个季度的输入材料，生成一份结构化的对比分析报告。报告必须包含以下所有部分：

#### 1. 综合评估与投资启示 (Synthesis & Implications)

- **核心结论 (Key Takeaway)：**
  必须按以下子主题结构化拆解，每个子主题都要有数字和页码引用：
  * **增长动能**：[哪个业务加速？数字？来源页码？格式："{curr} $X (+Y% YoY) vs {prev} $X (+Y% YoY)，加速/减速"]
  * **盈利质量**：[一次性项目？调整后的真实趋势？明确指出可比性陷阱]
  * **资本强度**：[CapEx/FCF变化？管理层指引？]

- **投资启示（决策导向）：** [综合上述分析，给出对投资决策的直接影响，用一段话总结"偏多信号"和"风险升级"两方面]

- **"Devil's Advocate" 视角：** [基于{curr}分析，必须引用具体数据和页码，列出2-3个核心风险点]

- **对估值/模型的影响：**
  必须回答（用"你需要..."或"模型必须..."的语气）：
  1）**收入侧**（上修/下修概率：高/中/低）：[具体哪些业务线需要调整？]
  2）**成本/资本侧**（下修FCF概率：高/中/低）：[FCF路径需要怎么改？为什么是"必选项而非可选项"？]
  3）**估值框架**（乘数变化的理由）：[可能从"高质量复利"向"高增长重资产"偏移？]

**A. 概率化情景（合计=100%）+ 价格影响区间（未来6-12个月）**

| 情景 | 概率 | 关键假设/触发器 | 价格影响 | 验证指标 |
|:---|:---|:---|:---|:---|
| Bull | [__]% | ①[…] ②[…] ③[…] | +[]%–[]% | [指标A \\| 时间窗] |
| Base | [__]% | ①[…] ②[…] ③[…] | []%–[]% | |
| Bear | [__]% | ①[…] ②[…] ③[…] | −[]%–[]% | |

**B. 催化板 (Catalyst Board)**

| 时间窗 | 事件 | 概率(%) | 方向(+/−) | 验证数据/来源 | 备注 |
|:---|:---|:---|:---|:---|:---|
| 0–3m | [事件] | []% | | [来源页码] | [transcript中的相关披露] |
| 3–12m | [事件] | []% | | [来源页码] | |
| >12m | [事件] | [__]% | | [来源页码] | |

---

#### 2. 业绩概览 (Performance Snapshot) - [对比版]

**A. 当季业绩表现 (Current Quarter Performance)**

注：每个数字都要标注来源页码；两季均存在一次性项扰动时需注明

| 指标 | {curr} 报告值 | {prev} 报告值 | QoQ 变化 | {curr} YoY | {prev} YoY |
|:---|:---|:---|:---|:---|:---|
| 营收 | [值] (p.X) | [值] (p.Y) | +X% | +X% | +X% |
| 毛利率（推算） | X% | X% | +X pp | | |
| 营业利润 | [值] (p.X) | [值] (p.Y) | +X% | +X%（受[一次性项]影响） | +X%（受[一次性项]影响；剔除后+X%） |
| EPS | [值] (p.X) | [值] (p.Y) | +/-X% | +X% | +X% |
| Other Income | [值] (p.X) | [值] (p.Y) | | | |

*可比性说明：*
- {prev}有$X的[一次性项目]，{curr}有$Y的[一次性项目]
- Other income波动巨大（{prev} $X vs {curr} $Y）：EPS的季度对比应更多看经营利润与现金流

**B. 未来业绩指引 (Forward-Looking Guidance)**

| 指引指标 | {curr}发布的新指引 | {prev}发布的旧指引 | 指引变动 | 斜率 (Slope) | 隐含下一季/年 |
|:---|:---|:---|:---|:---|:---|
| FY Capex | [值] (p.X) | [值] (p.Y) | 从定性→定量 / +X% | N/A | |
| 折旧/运营成本 | [描述] (p.X) | [描述] (p.Y) | 压力前置/更明确 | | |
| 供需环境 | [描述] (p.X) | [描述] (p.Y) | 延续/恶化/改善 | | |

---

#### 3. 核心业绩驱动 (Segment & Geographic Drivers)

**A. 数据口径与非GAAP调整（两季"可比性陷阱"）：**
- {prev}：[$X的一次性项目]计入[费用线]，压低/抬高当季[指标]；管理层给出了"剔除后"的口径（[具体数字]）(p.X)
- {curr}：[$Y的一次性项目]计入[费用线]，对[指标]的影响 (p.X)
- Other income波动巨大（{prev} $X vs {curr} $Y）：[解释原因]

**B. 按业务线 (By Segment):**

*1）[主要分部名称]（核心：[子业务列表]）*
- 分部收入：{curr} $X vs {prev} $Y（两季均+X% YoY，但{curr}规模扩大、结构更偏[子业务]）(p.X；p.Y)
- 分部利润率：{curr} X% vs {prev} Y%（{prev}被[一次性项]压低；若粗略加回，underlying可能与{curr}接近）(p.X；p.Y)

*2）[子业务1]*
- {curr}：$X，+X% YoY (p.X)
- {prev}：$Y，+X% YoY (p.Y)
- 变化分析：**加速/减速（+X pp）**
- 驱动拆解（管理层口径）：
  - 垂类：[具体描述] (p.X)
  - 产品：[具体描述] (p.X)
  - 变现：[具体描述] (p.X)
- **需要更关注的"二阶效应"：**[间接影响分析]

*3）[子业务2]*
- [同上格式]

**C. 关键经营指标（如适用）：**
| 指标 | {curr} | {prev} | 变化 |
|:---|:---|:---|:---|
| [KPI 1] | [值] (p.X) | [值] (p.Y) | +X% |
| [KPI 2] | [值] (p.X) | [值] (p.Y) | +X% |

**D. 按地域 (By Geography) ——披露限制下的"可用信息"：**
- 电话会中缺少系统性地域收入拆分，无法做严格地理对比
- 可以提取"采用与产品 rollout"维度的地理线索：
  - {prev}：[具体描述] (p.X)
  - {curr}：[具体描述] (p.X)

---

#### 4. 管理层叙事演变 (Management Narrative Evolution)

| 方面 | {curr} 叙事重点 | {prev} 叙事重点 | 演变分析 |
|:---|:---|:---|:---|
| 战略优先级 | [具体描述+页码] | [具体描述+页码] | 从"[旧重点]"→"[新重点]"。{curr}更像进入"[新阶段]"。 |
| 竞争定位 | [具体描述+页码] | [具体描述+页码] | {curr}更"外显"地把竞争优势落到[具体方面] |
| 资本配置 | [具体描述+页码] | [具体描述+页码] | {curr}把"资本开支"从风险提示升级为核心投资命题 |

---

#### 5. [本季]分析师Q&A透视 ({curr} Q&A Deep Dive)

**回应评分标准 (Response Scoring Standard):**
- 回应直接性 (Directness) [0–3]: 3=给数值/区间；2=给方向+量级；1=抽象/转移；0=未答
- 数据量 (Data Level) [0–3]: 3=具体数；2=区间/公式；1=仅定性；0=无新信息

**统计：**{curr}共[X]个问题，{prev}共[Y]个问题（每位分析师的每个子问题计1个问题）

**A. 关键主题识别（{curr}）:**
1. [主题1]（"[核心关注]"）
2. [主题2]
3. [主题3]

**B. 按主题分类的Q&A详细分析:**

**【极其重要】必须列出Q&A环节中的每一个问题，不能遗漏任何问题。每个主题下通常有3-5个问题，全部列出。**

*主题一：[主题名称]*

| 问题 | 分析师/机构 | 管理层回应摘要 | Directness | Data Level | 议题性质 |
|:---|:---|:---|:---|:---|:---|
| [问题1摘要] | [姓名] / [机构] | [回应摘要，包含具体数据点和页码] (p.X) | [0-3] | [0-3] | [短期建模/长期竞争力/合规与政策] |
| [问题2摘要] | [姓名] / [机构] | [回应摘要] (p.X) | [0-3] | [0-3] | |
| [问题3摘要] | [姓名] / [机构] | [回应摘要] (p.X) | [0-3] | [0-3] | |
| [问题4摘要] | [姓名] / [机构] | [回应摘要] (p.X) | [0-3] | [0-3] | |

*主题二：[主题名称]*

| 问题 | 分析师/机构 | 管理层回应摘要 | Directness | Data Level | 议题性质 |
|:---|:---|:---|:---|:---|:---|
| [问题1] | [姓名] / [机构] | [回应摘要] (p.X) | [0-3] | [0-3] | |
| [问题2] | [姓名] / [机构] | [回应摘要] (p.X) | [0-3] | [0-3] | |
| [问题3] | [姓名] / [机构] | [回应摘要] (p.X) | [0-3] | [0-3] | |

*主题三：[主题名称]*
[同上格式，继续列出该主题下的所有问题]

*主题四/五/六...*
[继续，直到所有Q&A问题都被分类和分析完毕]

**【重要】对于管理层回避或未充分回答的问题，单独列出：**

| 问题 | 分析师/机构 | 管理层如何回避 | 投资含义 |
|:---|:---|:---|:---|
| [问题] | [姓名/机构] | [回避方式描述] (p.X) | [对模型/估值的影响] |

---

#### 6. 季度间主题演变 (Thematic Evolution)

**A. Q&A主题量化对比（按"问题数"归类）:**

口径：每位分析师的每个子问题计1个问题；{curr}共[X]个问题，{prev}共[Y]个问题

| 主题 | {curr} 问题数 | {curr} 占比 | {prev} 问题数 | {prev} 占比 | 趋势 |
|:---|:---|:---|:---|:---|:---|
| [主题A] | X | X% | X | X% | 升温/降温（市场从"[旧关注]"转向"[新关注]"） |
| [主题B] | X | X% | X | X% | |

**B. 关键议题回应演变（从"可建模性"角度打分）:**

| 议题 | {prev}回应总结 | 评分 | {curr}回应总结 | 评分 | 变化分析 |
|:---|:---|:---|:---|:---|:---|
| [议题1] | [摘要] (p.X) | D[0-3]/DL[0-3] | [摘要] (p.Y) | D[0-3]/DL[0-3] | **可建模性提升/下降**：[具体解释，风险不是"[A]"，而是"[B]"，估值折价可能来自不确定性本身] |
| [议题2] | [摘要] (p.X) | D[0-3]/DL[0-3] | [摘要] (p.Y) | D[0-3]/DL[0-3] | [具体解释] |

---

#### 7. 前次 Insight 验证追踪 (Prior Insight Tracking)

**【条件性输出】仅在 A 部分提供了 "前次分析 Insights 跟踪" 时输出此 section。如果没有 prior insights，跳过此 section。**

**对每条 prior insight 逐一回应：**

| ID | Insight | 判定 | 本季度关键证据 | 建议操作 |
|:---|:---|:---|:---|:---|
| INS-XXX | [标题] | ✅/❌/⏳/🔄 | [transcript 中的具体证据 + 页码] | [结案/保持/修正为"..."] |

**判定标准：**
- ✅ 已验证：transcript 中有**明确、可引用的证据**支持该假设。**必须附带页码引用，否则禁止判定为 ✅。**
- ❌ 推翻：transcript 中有明确证据否定该假设
- ⏳ 证据不足：本次 transcript 未涉及或证据不明确。**这是默认判定——当你犹豫时，选 ⏳ 而非 ✅。**
- 🔄 需修正：假设方向正确但需要更新细节（如时间线、幅度）

**【反幻觉指令】不允许在没有 transcript 原文引用的情况下判定 ✅ 或 ❌。如果管理层只是泛泛提及相关话题但没有提供可验证的具体数据，判定为 ⏳。宁可多判 ⏳，不可错判 ✅。**

**对每条 🔄 修正的 insight，给出建议的修正后表述。**
**对每条 ❌ 推翻的 insight，提炼一条教训（lesson learned）。**

**注意：Section 8 的判定仅为 AI 建议。最终状态更新由分析师在 Insight Ledger 中手动完成。**

---

## 指令结束
"""
